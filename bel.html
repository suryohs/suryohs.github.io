<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aplikasi Bel Cerdas Cermat</title>
  <style>
    body{font-family:sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;background:#f3f4f6}
    .card{background:#fff;padding:24px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.1);width:400px;text-align:center}
    h1{margin:0 0 20px;font-size:20px}
    select,input,button{width:100%;margin-top:10px;padding:12px;border-radius:8px;border:1px solid #ccc;font-size:15px}
    button{background:#0b5fff;color:#fff;font-weight:bold;cursor:pointer;border:0}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .status{margin-top:12px;font-size:14px;color:#555}
  </style>
</head>
<body>
  <div class="card">
    <h1>Aplikasi Bel</h1>
    <input id="name" placeholder="Nama peserta" />
    <select id="group">
      <option value="">-- Pilih Kelompok --</option>
      <option value="1">Kelompok 1</option>
      <option value="2">Kelompok 2</option>
      <option value="3">Kelompok 3</option>
      <option value="4">Kelompok 4</option>
      <option value="5">Kelompok 5</option>
      <option value="6">Kelompok 6</option>
      <option value="7">Kelompok 7</option>
      <option value="8">Kelompok 8</option>
    </select>
    <button id="loginBtn">Login</button>
    <div id="panel" style="display:none">
      <button id="bellBtn">ðŸ”” Tekan Bel</button>
      <div class="status" id="who">Bel belum aktif</div>
    </div>
  </div>

  <!-- Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // ðŸ”§ GANTI INI DENGAN CONFIG FIREBASE PROJECT ANDA
    const firebaseConfig = {
      apiKey: "ISI_API_KEY",
      authDomain: "ISI_PROJECT.firebaseapp.com",
      databaseURL: "https://ISI_PROJECT.firebaseio.com",
      projectId: "ISI_PROJECT",
      storageBucket: "ISI_PROJECT.appspot.com",
      messagingSenderId: "ISI_SENDER_ID",
      appId: "ISI_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const loginBtn = document.getElementById('loginBtn');
    const bellBtn = document.getElementById('bellBtn');
    const nameInput = document.getElementById('name');
    const groupSelect = document.getElementById('group');
    const panel = document.getElementById('panel');
    const who = document.getElementById('who');

    let my = {name:null,group:null,id:null};

    const words = {
      1:'satu',2:'dua',3:'tiga',4:'empat',5:'lima',6:'enam',7:'tujuh',8:'lapan'
    };

    function uid(){ return 'u_' + Math.random().toString(36).substr(2,9); }

    function play(word){
      return new Promise(resolve=>{
        let i=0;
        function next(){
          if(i>=3){resolve();return;}
          let u = new SpeechSynthesisUtterance(word);
          u.lang = 'id-ID';
          u.onend=()=>{i++;setTimeout(next,300);}
          speechSynthesis.speak(u);
        }
        next();
      });
    }

    function observe(){
      db.ref('currentBell').on('value', snap=>{
        const v=snap.val();
        if(!v || !v.playing){
          who.textContent='Bel belum aktif';
          bellBtn.disabled=false;
        } else {
          who.textContent=`Kelompok ${v.group} (${v.name}) menekan`;
          bellBtn.disabled=true;
        }
      });
    }

    async function press(){
      const ref=db.ref('currentBell');
      const payload={playing:true,group:my.group,name:my.name,id:my.id,ts:Date.now()};
      ref.transaction(curr=>{
        if(!curr || !curr.playing){ return payload; }
        return; // sudah ada
      },async(err,committed,snap)=>{
        if(committed){
          await play(words[my.group]||'bel');
          ref.set({playing:false,last:payload});
        }
      });
    }

    loginBtn.onclick=()=>{
      const n=nameInput.value.trim();
      const g=groupSelect.value;
      if(!n||!g){alert('Isi nama & pilih kelompok');return;}
      my={name:n,group:g,id:uid()};
      loginBtn.disabled=true;nameInput.disabled=true;groupSelect.disabled=true;
      panel.style.display='block';
      observe();
    };

    bellBtn.onclick=()=>{ press(); };

    window.onbeforeunload=()=>{
      db.ref('currentBell').transaction(curr=>{
        if(curr && curr.playing && curr.id===my.id){
          return {playing:false,last:curr};
        }
        return curr;
      });
    };
  </script>
</body>
</html>
