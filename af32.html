<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assesmen Formatif</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--ok:#10b981;--bad:#ef4444;}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, system-ui, Arial;background:linear-gradient(180deg,#071024 0%, #071a2a 100%);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.05));border-radius:12px;padding:20px;max-width:820px;width:100%;box-shadow:0 8px 24px rgba(2,6,23,0.6)}
    h1{margin:0 0 12px;font-size:20px}
    label{display:block;margin:8px 0 6px;color:var(--muted);font-size:13px}
    select,input,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    .row{display:flex;gap:12px}
    .row>.col{flex:1}
    button{cursor:pointer;background:var(--accent);border:none;color:#012; font-weight:600}
    .muted{color:var(--muted);font-size:13px}
    .center{text-align:center}
    .hidden{display:none}
    .small{font-size:13px}
    .danger{color:var(--bad)}
    .ok{color:var(--ok)}
    .footer{display:flex;justify-content:space-between;gap:12px;margin-top:12px}
    .big{font-size:18px}
    .timer{font-weight:700;font-size:20px}
    pre{white-space:pre-wrap;background:rgba(255,255,255,0.02);padding:8px;border-radius:6px}
  </style>
</head>
<body>
  <div class="card" id="app">
    <!-- Page: Login -->
    <div id="page-login">
      <h1>Assesmen Formatif — Login</h1>
      <p class="muted">Terhubung ke server untuk mengambil daftar peserta. Jika koneksi gagal, tidak ada menu demo.</p>

      <label for="username">Username</label>
      <select id="username"></select>

      <label for="password">Password</label>
      <input id="password" type="password" autocomplete="off" />

      <label for="jenis">Jenis Tes</label>
      <select id="jenis">
        <option value="AF32">AF32 KALI BAGI DESIMAL</option>
      </select>

      <div class="footer">
        <div class="muted small">Status: <span id="status">Mengambil data...</span></div>
        <button id="btn-login">Login</button>
      </div>
    </div>

    <!-- Page: Confirm -->
    <div id="page-confirm" class="hidden">
      <h1>Konfirmasi Mulai</h1>
      <div class="small">
        <p>Username: <strong id="c-username"></strong></p>
        <p>Password: <strong id="c-password"></strong></p>
        <p>Jenis Tes: <strong id="c-jenis"></strong></p>
      </div>

      <label for="token">Token</label>
      <input id="token" type="text" autocomplete="off" />

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="btn-validate">Mulai Tes</button>
        <button id="btn-back">Kembali</button>
      </div>
      <p id="confirm-msg" class="muted small"></p>
    </div>

    <!-- Page: Asesmen -->
    <div id="page-test" class="hidden">
      <h1 id="test-title">Asesmen</h1>
      <div id="countdown-start" class="center big">Siap? <span id="countdown-number">3</span></div>

      <div id="question-area" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="small">Soal <span id="q-index">1</span> / <span id="q-total">5</span></div>
          <div class="timer" id="q-timer">01:30</div>
        </div>

        <div style="margin-top:12px">
          <pre id="q-text" class="big"></pre>
        </div>

        <label for="answer">Jawaban (essay)</label>
        <input id="answer" type="text" autocomplete="off" />

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btn-submit">Kirim Jawaban</button>
          <button id="btn-skip">Lewati</button>
        </div>

        <p id="feedback" class="muted"></p>
      </div>

    </div>

    <!-- Page: Result -->
    <div id="page-result" class="hidden">
      <h1>Hasil</h1>
      <div id="result-list"></div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="btn-done">Selesai</button>
      </div>
      <p class="muted small">Data akan dikirim otomatis ke spreadsheet.</p>
      <p id="send-msg" class="muted small"></p>
    </div>

  </div>

<script>
(function(){
  const API = 'https://script.google.com/macros/s/AKfycbwLkVTPIG0bOxSCHQHiT7kNWge6mIheTqH_qb6ghAqiD_8RUl96RVKmZ5BQJptfBcAFhg/exec';

  // state
  let students = [];
  let currentStudent = null;
  let selectedJenis = 'AF32';
  let testStartTime = null;
  let testEndTime = null;
  let questions = [];
  let qIndex = 0;
  let correctCount = 0;
  let qTimer = null;
  let qTimeLeft = 90;

  // elements
  const el = id=>document.getElementById(id);
  const pageLogin = el('page-login');
  const pageConfirm = el('page-confirm');
  const pageTest = el('page-test');
  const pageResult = el('page-result');

  // initial fetch student data
  fetch(API)
    .then(r=>r.json())
    .then(j=>{
      if(!j.success) throw new Error(j.error||'gagal');
      students = j.data || [];
      if(!Array.isArray(students) || students.length===0) {
        el('status').textContent = 'Tidak ada peserta di server.';
        throw new Error('no peserta');
      }
      // sort by nama
      students.sort((a,b)=> (''+a.nama).localeCompare((''+b.nama),'id'));
      const sel = el('username');
      sel.innerHTML = '';
      students.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.nama;
        opt.textContent = s.nama;
        sel.appendChild(opt);
      });
      el('status').textContent = 'Terhubung.';
    })
    .catch(err=>{
      console.error(err);
      el('status').textContent = 'Gagal terhubung ke server. Tidak ada demo.';
      // disable login button
      el('btn-login').disabled = true;
    });

  // login
  el('btn-login').addEventListener('click', ()=>{
    const uname = el('username').value;
    const pass = el('password').value.trim();
    selectedJenis = el('jenis').value;
    if(!uname || !pass) { alert('Isi username dan password'); return; }
    const found = students.find(s=>s.nama===uname);
    if(!found) { alert('Username tidak ditemukan'); return; }
    // password check against second column (kelas)
    if(String(found.kelas) !== pass) { alert('Password salah'); return; }
    // success
    currentStudent = found;
    // show confirm page
    el('c-username').textContent = currentStudent.nama;
    el('c-password').textContent = pass;
    el('c-jenis').textContent = selectedJenis + ' KALI BAGI DESIMAL';
    showPage('confirm');
  });

  el('btn-back').addEventListener('click', ()=> showPage('login'));

  el('btn-validate').addEventListener('click', ()=>{
    const tokenIn = el('token').value.trim();
    if(!tokenIn) { alert('Masukkan token'); return; }
    // validate token: match student with same nama, jenisTes and token
    const match = students.find(s=> s.nama===currentStudent.nama && (s.jenisTes||'')===selectedJenis && String(s.token)===tokenIn);
    if(!match) {
      el('confirm-msg').innerHTML = '<span class="danger">Token tidak cocok untuk user/jenis tes.</span>';
      return;
    }
    el('confirm-msg').innerHTML = '<span class="ok">Token valid — tes akan dimulai.</span>';
    // proceed to test after short delay
    setTimeout(()=>startTest(),700);
  });

  // Build questions generator for AF32 KALI BAGI DESIMAL
  function genQuestions(n){
    const qs = [];
    for(let i=0;i<n;i++){
      // randomly choose operation multiply or divide (60% multiply)
      const op = Math.random()<0.6? 'x':'÷';
      // select decimal like examples: one decimal with 1-2 decimal places between -0.5 and 0.5 or -0.42 to 0.42
      const a = (Math.random()*0.9 - 0.45).toFixed(2); // -0.45..0.45
      // b integer between -9 and 9 excluding -1,0,1 for interesting results
      let b = Math.floor(Math.random()*19)-9;
      if(b>=-1 && b<=1) b = 4; // avoid trivial
      if(op==='x'){
        const text = `${a} ${op} ${b}`;
        const answer = (parseFloat(a) * b);
        qs.push({text,answer});
      } else {
        // division: make dividend from decimal and integer divisor
        // ensure result not too long
        const b2 = (Math.random()*18-9).toFixed(0);
        let divisor = parseInt(b2)||3;
        if(divisor===0) divisor=3;
        const dividend = (parseFloat(a) * divisor).toFixed(2);
        const text = `${dividend} ${op} ${divisor}`;
        const answer = (parseFloat(dividend) / divisor);
        qs.push({text,answer});
      }
    }
    return qs;
  }

  function startTest(){
    // show page test
    showPage('test');
    // prepare questions
    questions = genQuestions(5);
    qIndex = 0; correctCount = 0;
    el('q-total').textContent = questions.length;
    // start pre-countdown 3..1
    el('countdown-start').classList.remove('hidden');
    el('question-area').classList.add('hidden');
    let n = 3; el('countdown-number').textContent = n;
    const cd = setInterval(()=>{
      n--; el('countdown-number').textContent = n;
      if(n<=0){ clearInterval(cd);
        el('countdown-start').classList.add('hidden');
        // request fullscreen
        requestFullScreen().then(()=>{
          // disable tab
          window.addEventListener('keydown', blockTab);
          // start timer
          testStartTime = Date.now();
          // show first question
          showQuestion(qIndex);
        }).catch(err=>{
          console.warn('Fullscreen gagal atau ditolak',err);
          // still attempt to continue but per requirement, if not fullscreen maybe treat accordingly
          // We'll still start but immediately check fullscreenchange to finish if user exits.
          testStartTime = Date.now();
          window.addEventListener('keydown', blockTab);
          showQuestion(qIndex);
        });
      }
    },1000);
  }

  function showQuestion(index){
    if(index>=questions.length){ finishTest(); return; }
    qIndex = index;
    el('q-index').textContent = index+1;
    el('q-text').textContent = questions[index].text;
    el('answer').value = '';
    el('feedback').textContent = '';
    el('question-area').classList.remove('hidden');
    // reset per-question timer
    clearInterval(qTimer);
    qTimeLeft = 90;
    updateTimerDisplay();
    qTimer = setInterval(()=>{
      qTimeLeft--; updateTimerDisplay();
      if(qTimeLeft<=0){ clearInterval(qTimer); handleTimeout(); }
    },1000);
  }

  function updateTimerDisplay(){
    const mm = String(Math.floor(qTimeLeft/60)).padStart(2,'0');
    const ss = String(qTimeLeft%60).padStart(2,'0');
    el('q-timer').textContent = `${mm}:${ss}`;
  }

  function handleTimeout(){
    // treat as wrong
    const correct = questions[qIndex].answer;
    el('feedback').innerHTML = `<span class="danger">Waktu habis. Jawaban benar: ${formatNumber(correct)}</span>`;
    setTimeout(()=> showQuestion(qIndex+1),5000);
  }

  el('btn-submit').addEventListener('click', ()=>{
    submitAnswer();
  });
  el('btn-skip').addEventListener('click', ()=>{
    // skip treated as wrong
    clearInterval(qTimer);
    const correct = questions[qIndex].answer;
    el('feedback').innerHTML = `<span class="danger">Dinyatakan salah. Jawaban benar: ${formatNumber(correct)}</span>`;
    setTimeout(()=> showQuestion(qIndex+1),5000);
  });

  function submitAnswer(){
    clearInterval(qTimer);
    const raw = el('answer').value.trim();
    if(raw===''){ el('feedback').textContent = 'Masukkan jawaban atau tekan Lewati.'; return; }
    const given = Number(raw.replace(',','.'));
    const correct = questions[qIndex].answer;
    const ok = !isNaN(given) && Math.abs(given - correct) < 0.01; // tolerance
    if(ok){
      correctCount++;
      el('feedback').innerHTML = `<span class="ok">Benar</span>`;
      setTimeout(()=> showQuestion(qIndex+1),2000);
    } else {
      el('feedback').innerHTML = `<span class="danger">Salah. Jawaban benar: ${formatNumber(correct)}</span>`;
      setTimeout(()=> showQuestion(qIndex+1),5000);
    }
  }

  function formatNumber(x){
    if (Number.isInteger(x)) return String(x);
    return (Math.round(x*100)/100).toString();
  }

  // fullscreen helpers
  function requestFullScreen(){
    return new Promise((resolve,reject)=>{
      const elDoc = document.documentElement;
      if(elDoc.requestFullscreen) return elDoc.requestFullscreen().then(resolve).catch(reject);
      if(elDoc.webkitRequestFullscreen) return elDoc.webkitRequestFullscreen().then(resolve).catch(reject);
      reject(new Error('Fullscreen API tidak tersedia'));
    });
  }

  document.addEventListener('fullscreenchange', ()=>{
    if(!document.fullscreenElement){
      // user exited fullscreen: end test immediately
      finishTest();
    }
  });

  // prevent tab key
  function blockTab(e){ if(e.key==='Tab'){ e.preventDefault(); } }

  function finishTest(){
    // remove listeners
    window.removeEventListener('keydown', blockTab);
    clearInterval(qTimer);
    testEndTime = Date.now();
    // exit fullscreen if still in
    if(document.fullscreenElement){ if(document.exitFullscreen) document.exitFullscreen(); }
    // prepare result
    const score = correctCount * 20;
    const durMs = Math.max(0, (testEndTime - testStartTime));
    const dur = Math.round(durMs/1000); // seconds
    const waktuSimpan = new Date().toISOString();

    // populate result page
    const data = {
      nama: currentStudent.nama,
      kelas: currentStudent.kelas,
      jenisTes: selectedJenis,
      token: el('token').value.trim(),
      score: score,
      durasi: dur,
      waktuSimpan: waktuSimpan
    };

    const rlist = el('result-list');
    rlist.innerHTML = `
      <p><strong>NAMA:</strong> ${escapeHtml(data.nama)}</p>
      <p><strong>KELAS:</strong> ${escapeHtml(data.kelas)}</p>
      <p><strong>JENIS_TES:</strong> ${escapeHtml(data.jenisTes)}</p>
      <p><strong>TOKEN:</strong> ${escapeHtml(data.token)}</p>
      <p><strong>SCORE:</strong> ${data.score}</p>
      <p><strong>DURASI (detik):</strong> ${data.durasi}</p>
      <p><strong>WAKTU_SIMPAN:</strong> ${data.waktuSimpan}</p>
    `;

    // send data to spreadsheet via fetch with mode no-cors and JSON
    try{
      fetch(API, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
      el('send-msg').textContent = 'Data dikirim (mode no-cors).';
    }catch(e){
      console.warn('send failed',e);
      el('send-msg').textContent = 'Gagal mengirim data otomatis.';
    }

    showPage('result');
  }

  el('btn-done').addEventListener('click', ()=>{
    location.reload();
  });

  function showPage(name){
    pageLogin.classList.toggle('hidden', name!=='login');
    pageConfirm.classList.toggle('hidden', name!=='confirm');
    pageTest.classList.toggle('hidden', name!=='test');
    pageResult.classList.toggle('hidden', name!=='result');
  }

  function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

  // initially show login
  showPage('login');

})();
</script>
</body>
</html>
