<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Assesmen Formatif</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--text:#e6eef8}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,Arial;background:linear-gradient(180deg,#071021 0%, #07162a 100%);color:var(--text)}
    .wrap{max-width:900px;margin:28px auto;padding:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:20px;border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 14px;font-size:20px}
    label{display:block;font-size:13px;color:var(--muted);margin-top:12px}
    select,input,textarea,button{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);font-size:15px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .hidden{display:none}
    .center{display:flex;gap:8px;align-items:center}
    .small{font-size:13px;color:var(--muted)}
    .btn{background:var(--accent);color:#012;cursor:pointer;border:none;padding:10px 14px;border-radius:8px}
    .danger{background:#ef4444}
    .question{font-size:18px;margin:12px 0}
    .timer{font-weight:700}
    .status{margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" id="page-login">
      <h1>Assesmen Formatif — Login</h1>
      <p class="small">Hubungkan ke server untuk memuat daftar peserta. Jika gagal, aplikasi tidak menyediakan demo.</p>
      <div id="loading">Memuat peserta...</div>
      <div id="login-form" class="hidden">
        <label>Username</label>
        <select id="usernameSelect"></select>

        <label>Password</label>
        <input id="passwordInput" type="password" autocomplete="new-password" />

        <label>Jenis Tes</label>
        <select id="jenisTesSelect">
          <option>AF32 KALI BAGI DESIMAL</option>
        </select>

        <div style="margin-top:12px" class="row">
          <button id="loginBtn" class="btn col">Masuk</button>
        </div>
        <div id="loginError" class="small" style="color:#fca5a5;margin-top:8px"></div>
      </div>
    </div>

    <div class="card hidden" id="page-confirm">
      <h1>Konfirmasi Mulai</h1>
      <p class="small">Periksa kembali data Anda, lalu masukkan token dan mulai tes.</p>
      <div><strong>Username:</strong> <span id="confirmUsername"></span></div>
      <div><strong>Password:</strong> <span id="confirmPassword"></span></div>
      <div><strong>Jenis Tes:</strong> <span id="confirmJenis"></span></div>

      <label style="margin-top:12px">Token</label>
      <input id="tokenInput" type="text" />

      <div style="margin-top:12px" class="row">
        <button id="backBtn" class="col">Kembali</button>
        <button id="startBtn" class="btn col">Mulai Tes</button>
      </div>

      <div id="tokenError" class="small" style="color:#fca5a5;margin-top:8px"></div>
    </div>

    <div class="card hidden" id="page-test">
      <h1>Asesmen — Soal <span id="qIndex">1</span>/5</h1>
      <div class="small">Waktu tiap soal: <span class="timer" id="qTimer">90</span> detik</div>
      <div id="preCount" class="question" style="font-size:48px;text-align:center;margin:18px 0"></div>
      <div id="questionArea" class="hidden">
        <div class="question" id="questionText"></div>
        <label>Jawaban (essay)</label>
        <textarea id="answerInput" rows="3"></textarea>
        <div style="margin-top:10px" class="row">
          <button id="skipBtn" class="col">Lewati</button>
          <button id="submitAnswerBtn" class="btn col">Kirim Jawaban</button>
        </div>
        <div id="feedback" class="status small"></div>
      </div>
    </div>

    <div class="card hidden" id="page-result">
      <h1>Hasil</h1>
      <div id="resultData"></div>
      <div style="margin-top:12px" class="small">Data akan terkirim otomatis ke spreadsheet.</div>
      <div style="margin-top:12px" class="row">
        <button id="restartBtn" class="col">Mulai Ulang</button>
      </div>
    </div>
  </div>

  <script>
    // ------- Konfigurasi -------
    const API_URL = 'https://script.google.com/macros/s/AKfycbwLkVTPIG0bOxSCHQHiT7kNWge6mIheTqH_qb6ghAqiD_8RUl96RVKmZ5BQJptfBcAFhg/exec';
    // ---------------------------

    let students = [];
    let currentStudent = null;
    let selectedJenis = null;
    let enteredToken = '';
    let questions = [];
    let currentIndex = 0;
    let score = 0;
    let page3EnterTime = null;
    let qTimerInterval = null;
    let qTimeLeft = 90;

    // Utility
    const $ = id => document.getElementById(id);
    function show(id){$(id).classList.remove('hidden')}
    function hide(id){$(id).classList.add('hidden')}

    // Fetch peserta dari server
    async function loadStudents(){
      try{
        const res = await fetch(API_URL);
        const json = await res.json();
        if(json.success && Array.isArray(json.data)){
          students = json.data.slice();
          // Sort by nama alphabet
          students.sort((a,b)=>{return String(a.nama).localeCompare(String(b.nama),'id')});
          populateUsernameSelect();
          hide('loading');
          show('login-form');
        } else {
          throw new Error('Data peserta kosong');
        }
      }catch(err){
        $('loading').textContent = 'Gagal memuat peserta — koneksi/API bermasalah. Aplikasi tidak menyediakan mode demo.';
        console.error('loadStudents:',err);
      }
    }

    function populateUsernameSelect(){
      const sel = $('usernameSelect');
      sel.innerHTML='';
      students.forEach((s,idx)=>{
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = s.nama + ' — ' + (s.kelas||'');
        sel.appendChild(opt);
      });
    }

    // LOGIN
    $('loginBtn').addEventListener('click',()=>{
      const idx = $('usernameSelect').value;
      const pw = $('passwordInput').value.trim();
      if(idx === '' || idx == null){$('loginError').textContent='Pilih username.';return}
      const st = students[Number(idx)];
      // Peraturan mapping: kolom 1 = nama (username), kolom2 = kelas (dipakai sebagai password)
      if(st.kelas == undefined){$('loginError').textContent='Data peserta tidak lengkap.';return}
      if(pw === st.kelas){
        // login success
        currentStudent = st;
        selectedJenis = $('jenisTesSelect').value;
        $('loginError').textContent='';
        goToConfirm();
      } else {
        $('loginError').textContent='Password salah.';
      }
    });

    function goToConfirm(){
      hide('page-login');
      show('page-confirm');
      $('confirmUsername').textContent = currentStudent.nama;
      $('confirmPassword').textContent = currentStudent.kelas;
      $('confirmJenis').textContent = selectedJenis;
    }

    $('backBtn').addEventListener('click',()=>{
      hide('page-confirm');show('page-login');
    });

    $('startBtn').addEventListener('click',()=>{
      enteredToken = $('tokenInput').value.trim();
      // Validate token and jenis against student record
      if(!enteredToken){$('tokenError').textContent='Token wajib diisi.';return}
      if(currentStudent.token == undefined){$('tokenError').textContent='Token tidak tersedia pada data peserta.';return}
      if(enteredToken !== String(currentStudent.token) || selectedJenis !== (currentStudent.jenisTes||'') ){
        $('tokenError').textContent='Token atau jenis tes tidak cocok.';return
      }
      $('tokenError').textContent='';
      startTest();
    });

    // ------------ Test flow ------------
    function startTest(){
      hide('page-confirm');
      show('page-test');
      // Generate 5 soal: kali atau bagi desimal (AF32)
      questions = generateQuestions(5);
      currentIndex = 0;score=0;
      page3EnterTime = new Date();

      // force fullscreen
      requestFullscreenSafe();

      // prevent tab key
      document.addEventListener('keydown', blockTab, true);

      // fullscreen exit listener
      document.addEventListener('fullscreenchange', onFullScreenChange);

      runPreCountThenShowQuestion();
    }

    function requestFullscreenSafe(){
      const el = document.documentElement;
      if(el.requestFullscreen) el.requestFullscreen().catch(()=>{});
    }
    function onFullScreenChange(){
      if(!document.fullscreenElement){
        // user left fullscreen -> end test
        finishTest('Anda keluar dari fullscreen. Tes selesai.');
      }
    }
    function blockTab(e){ if(e.key==='Tab'){ e.preventDefault(); } }

    function runPreCountThenShowQuestion(){
      $('preCount').textContent='3';
      show('preCount');hide('questionArea');
      let n=3;
      const t = setInterval(()=>{
        n--; if(n>0){$('preCount').textContent = String(n);} else {clearInterval(t); $('preCount').textContent=''; hide('preCount'); show('questionArea'); showQuestion(); } },1000);
    }

    function showQuestion(){
      if(currentIndex >= questions.length){ finishTest(); return }
      const q = questions[currentIndex];
      $('qIndex').textContent = String(currentIndex+1);
      $('questionText').textContent = q.text;
      $('answerInput').value='';
      $('feedback').textContent='';
      qTimeLeft = 90; $('qTimer').textContent = String(qTimeLeft);
      // start interval
      if(qTimerInterval) clearInterval(qTimerInterval);
      qTimerInterval = setInterval(()=>{
        qTimeLeft--; $('qTimer').textContent = String(qTimeLeft);
        if(qTimeLeft<=0){ clearInterval(qTimerInterval); onTimeUp(); }
      },1000);
    }

    function onTimeUp(){
      const q = questions[currentIndex];
      $('feedback').textContent = 'Waktu habis. Jawaban benar: ' + q.answer;
      // wait 5s then next
      setTimeout(()=>{ currentIndex++; showQuestion(); },5000);
    }

    $('submitAnswerBtn').addEventListener('click',()=>{ checkAnswer(); });
    $('skipBtn').addEventListener('click',()=>{ $('feedback').textContent='Soal dilewati. Jawaban benar: '+questions[currentIndex].answer; clearInterval(qTimerInterval); setTimeout(()=>{ currentIndex++; showQuestion(); },3000); });

    function normalizeNumberString(s){
      return String(s).replace(/\s+/g,'').replace(',','.');
    }

    function checkAnswer(){
      clearInterval(qTimerInterval);
      const q = questions[currentIndex];
      const userRaw = normalizeNumberString($('answerInput').value.trim());
      if(userRaw===''){ $('feedback').textContent='Jawaban kosong.'; qTimerInterval = setInterval(()=>{ qTimeLeft--; $('qTimer').textContent = String(qTimeLeft); if(qTimeLeft<=0){ clearInterval(qTimerInterval); onTimeUp(); } },1000); return }
      // compare numeric values allowing small floating rounding
      const userVal = Number(userRaw);
      const correctVal = Number(q.answer);
      const equal = Math.abs(userVal - correctVal) <= 1e-6;
      if(equal){
        score += 20; $('feedback').textContent = 'Benar! +20.';
        setTimeout(()=>{ currentIndex++; showQuestion(); },2000);
      } else {
        $('feedback').textContent = 'Salah. Jawaban benar: ' + q.answer;
        setTimeout(()=>{ currentIndex++; showQuestion(); },5000);
      }
    }

    function finishTest(reason){
      // cleanup
      if(qTimerInterval) clearInterval(qTimerInterval);
      document.removeEventListener('keydown', blockTab, true);
      document.removeEventListener('fullscreenchange', onFullScreenChange);
      // If fullscreen, try to exit to restore tabs
      if(document.fullscreenElement){ try{ document.exitFullscreen(); }catch(e){} }

      hide('page-test');
      show('page-result');

      const page4EnterTime = new Date();
      const durMs = page4EnterTime - page3EnterTime;
      const durSec = Math.max(0, Math.round(durMs/1000));
      const durStr = formatDuration(durSec);
      const waktuSimpan = page4EnterTime.toISOString();

      const payload = {
        nama: currentStudent.nama || '',
        kelas: currentStudent.kelas || '',
        jenisTes: selectedJenis || '',
        token: enteredToken || '',
        score: score,
        durasi: durStr,
        waktuSimpan: waktuSimpan
      };

      // tampilkan result
      const rd = $('resultData');
      rd.innerHTML = `
        <div><strong>Nama:</strong> ${escapeHtml(payload.nama)}</div>
        <div><strong>Kelas:</strong> ${escapeHtml(payload.kelas)}</div>
        <div><strong>Jenis Tes:</strong> ${escapeHtml(payload.jenisTes)}</div>
        <div><strong>Token:</strong> ${escapeHtml(payload.token)}</div>
        <div><strong>Score:</strong> ${payload.score}</div>
        <div><strong>Durasi:</strong> ${payload.durasi}</div>
        <div><strong>Waktu Simpan:</strong> ${payload.waktuSimpan}</div>
      `;

      // Kirim data otomatis ke spreadsheet (fetch mode no-cors sesuai permintaan)
      try{
        fetch(API_URL, {
          method: 'POST',
          mode: 'no-cors', // sesuai permintaan
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      }catch(e){ console.warn('Kirim data gagal',e); }

    }

    function formatDuration(s){
      const m = Math.floor(s/60); const sec = s%60; return `${m}m ${sec}s`;
    }

    $('restartBtn').addEventListener('click',()=>{ location.reload(); });

    // ------- Question generator (AF32: kali / bagi desimal) -------
    function generateQuestions(n){
      const qs=[];
      for(let i=0;i<n;i++){
        // randomly choose multiply or divide
        const op = Math.random() < 0.6 ? 'x' : '/';
        // Use decimals similar to examples: one operand decimal with 1-3 decimals, other integer or small decimal
        const sign1 = Math.random()<0.3? -1:1;
        const sign2 = Math.random()<0.3? -1:1;
        const decimals = Math.random()<0.6? 2 : 3;
        const a = (Math.round((Math.random()*1 + 0.01) * Math.pow(10,decimals)) / Math.pow(10,decimals)) * sign1; // between 0.01 and ~1.01
        let b;
        if(op === 'x'){
          // multiply by small integer 1..12 or small decimal
          if(Math.random()<0.7){ b = Math.floor(Math.random()*12)+1; } else { b = (Math.round((Math.random()*10+0.1)*100)/100)*sign2; }
        } else {
          // divide: divide decimal by integer or vice versa
          if(Math.random()<0.6){ b = Math.floor(Math.random()*12)+1; } else { b = (Math.round((Math.random()*10+0.1)*100)/100)*sign2; }
        }
        // Random chance to swap positions (example shows decimal then integer)
        let text, answer;
        if(op==='x'){
          text = `${a} × ${b}`;
          answer = (a * b).toString();
        } else {
          text = `${a} ÷ ${b}`;
          // avoid division by zero
          if(b===0){ b = 1; }
          answer = (a / b).toString();
        }
        // Round answer to at most 6 decimal places to reduce floating oddities
        const ansNum = Number(answer);
        const ansRounded = Math.round(ansNum * 1e6)/1e6;
        qs.push({text, answer: String(ansRounded)});
      }
      return qs;
    }

    function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // Start
    loadStudents();

    // Accessibility / safety: if user tries to close tab or refresh during test, warn
    window.addEventListener('beforeunload', function(e){ if(!document.getElementById('page-test').classList.contains('hidden')){ e.preventDefault(); e.returnValue='Tes sedang berjalan — jika ditutup tes akan selesai.'; } });

  </script>
</body>
</html>
